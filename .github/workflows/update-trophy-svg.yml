name: Update Trophy SVG

on:
  schedule:
    - cron: "0 * * * *"   # every hour
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      USERNAME: ${{ github.repository_owner }}

    steps:
      - uses: actions/checkout@v4

      - name: Fetch GitHub stats
        env:
          TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          curl -s -H "Authorization: token $TOKEN" \
          https://api.github.com/users/$USERNAME > user.json

      - name: Generate trophy.svg from template
        run: |
          POINTS=$(jq .public_repos user.json)

          # -------- RANK LOGIC (same idea as original) --------
          if [ "$POINTS" -ge 100 ]; then
            RANK="SSS"
            TITLE="You are at a hard to reach rank"
            NEXT=100
          elif [ "$POINTS" -ge 60 ]; then
            RANK="S"
            TITLE="You are at a hard to reach rank"
            NEXT=100
          elif [ "$POINTS" -ge 30 ]; then
            RANK="A"
            TITLE="You will reach this rank if you do your best"
            NEXT=60
          elif [ "$POINTS" -ge 10 ]; then
            RANK="B"
            TITLE="You are currently making good progress"
            NEXT=30
          elif [ "$POINTS" -ge 1 ]; then
            RANK="C"
            TITLE="You are currently making good progress"
            NEXT=10
          else
            RANK="?"
            TITLE="You have not taken action yet"
            NEXT=10
          fi

          # -------- PROGRESS WIDTH (max bar = 280px) --------
          WIDTH=$(( POINTS * 280 / NEXT ))
          if [ "$WIDTH" -gt 280 ]; then WIDTH=280; fi

          # -------- BUILD SVG --------
          cp assets/trophy-template.svg trophy.svg

          sed -i "s/{{RANK}}/$RANK/g" trophy.svg
          sed -i "s/{{TITLE}}/$TITLE/g" trophy.svg
          sed -i "s/{{POINTS}}/$POINTS/g" trophy.svg
          sed -i "s/{{PROGRESS_WIDTH}}/${WIDTH}/g" trophy.svg

      - name: Commit trophy
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git diff --quiet; then
            echo "No changes"
          else
            git add trophy.svg
            git commit -m "Update trophy SVG"
            git push
          fi
