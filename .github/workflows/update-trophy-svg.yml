name: Update Trophy SVG

on:
  schedule:
    - cron: "0 * * * *"   # runs every hour
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      USERNAME: ${{ github.repository_owner }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch GitHub user data
        env:
          TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -e
          curl -s -H "Authorization: token $TOKEN" \
          https://api.github.com/users/$USERNAME > user.json

      - name: Generate trophy.svg from template
        run: |
          set -e

          echo "Copying SVG template..."
          cp assets/trophy-template.svg trophy.svg

          echo "Calculating points..."
          POINTS=$(jq .public_repos user.json)

          if [ "$POINTS" -ge 100 ]; then
            RANK="SSS"
            TITLE="You are at a hard to reach rank"
            NEXT=100
          elif [ "$POINTS" -ge 60 ]; then
            RANK="S"
            TITLE="You are at a hard to reach rank"
            NEXT=100
          elif [ "$POINTS" -ge 30 ]; then
            RANK="A"
            TITLE="You will reach this rank if you do your best"
            NEXT=60
          elif [ "$POINTS" -ge 10 ]; then
            RANK="B"
            TITLE="You are currently making good progress"
            NEXT=30
          elif [ "$POINTS" -ge 1 ]; then
            RANK="C"
            TITLE="You are currently making good progress"
            NEXT=10
          else
            RANK="?"
            TITLE="You have not taken action yet"
            NEXT=10
          fi

          WIDTH=$(( POINTS * 280 / NEXT ))
          if [ "$WIDTH" -gt 280 ]; then WIDTH=280; fi

          echo "Injecting values into SVG..."
          sed -i "s|{{RANK}}|$RANK|g" trophy.svg
          sed -i "s|{{TITLE}}|$TITLE|g" trophy.svg
          sed -i "s|{{POINTS}}|$POINTS|g" trophy.svg
          sed -i "s|{{PROGRESS_WIDTH}}|$WIDTH|g" trophy.svg

          echo "SVG generated successfully."

      - name: Commit trophy.svg
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add trophy.svg
          git commit -m "Update trophy SVG" || echo "No changes to commit"
          git push
